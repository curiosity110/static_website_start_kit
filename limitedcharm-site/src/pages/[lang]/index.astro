---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero.astro';
import ProductCard from '../../components/ProductCard.astro';
import Stats from '../../components/Stats.astro';
import ContactBlock from '../../components/ContactBlock.astro';
import { getDictionary } from '../../i18n/dict';
import { SUPPORTED_LANGUAGES, DEFAULT_LANG, isLang } from '../../i18n/config';
import product1 from '../../content/products/product-1.mdx';
import product2 from '../../content/products/product-2.mdx';

// Local fallback images
import fallback1 from '../../assets/product1.png';
import fallback2 from '../../assets/product2.png';
import heroImage from '../../assets/product1.png';

export function getStaticPaths() {
  return SUPPORTED_LANGUAGES.map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;

if (!isLang(lang)) {
  throw Astro.redirect(`/${DEFAULT_LANG}/`);
}

const dict = getDictionary(lang) ?? {};

// Only keep valid product frontmatter
const rawProducts = [product1?.frontmatter, product2?.frontmatter].filter(Boolean);

// Map products and ensure images are always defined
const products = rawProducts.map((p, i) => ({
  ...p,
  image: p?.image
    ? new URL(p.image, import.meta.url).pathname
    : (i === 0 ? fallback1 : fallback2)
}));

const stats = [
  { label: dict?.stats?.years ?? '', value: '5+' },
  { label: dict?.stats?.orders ?? '', value: '1500+' },
  { label: dict?.stats?.satisfaction ?? '', value: '98%' }
];
---

<BaseLayout lang={lang} title="Home" description="">
  <!-- Hero section -->
  <Hero lang={lang} image={heroImage} />

  <!-- About/Benefits Section -->
  <section class="py-12">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-2xl font-bold mb-6">{dict?.about?.heading ?? ''}</h2>
      <ul class="max-w-md mx-auto list-disc list-inside space-y-2 text-left">
        {dict?.about?.benefits?.filter(Boolean).map((b) => <li>{b}</li>)}
      </ul>
    </div>
  </section>

  <!-- Featured Products Section -->
  <section id="products" class="py-12">
    <h2 class="text-2xl text-center font-bold mb-6">{dict?.nav?.products ?? 'Products'}</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      {products.map((p) => (
        <ProductCard lang={lang} {...p} />
      ))}
    </div>
  </section>

  <!-- Stats Section -->
  <Stats stats={stats} />

  <!-- Contact Section -->
  <ContactBlock lang={lang} />
</BaseLayout>
